function makeMove(problemNumber, fromRow, fromCol, toRow, toCol, isPlayerMove) {
    const state = gameStates[problemNumber];
    const problem = problems[problemNumber];
    
    const piece = state.currentPosition[fromRow][fromCol];
    
    // Mover la pieza correctamente
    state.currentPosition[toRow][toCol] = piece;
    state.currentPosition[fromRow][fromCol] = '';
    
    if (isPlayerMove) {
        state.playerMoves.push({
            from: { row: fromRow, col: fromCol },
            to: { row: toRow, col: toCol }
        });
        
        const expectedMove = problem.solution[state.currentMoveIndex].white;
        if (fromRow === expectedMove.from.row && fromCol === expectedMove.from.col &&
            toRow === expectedMove.to.row && toCol === expectedMove.to.col) {
            
            // ELIMINAR esta línea: state.currentMoveIndex++;
            
            if (state.currentMoveIndex === problem.solution.length - 1) {
                state.gameCompleted = true;
                document.getElementById(`status${problemNumber}`).innerHTML = "¡Felicidades! <span class='checkmate'>¡Jaque mate en 4 jugadas!</span>";
                document.getElementById(`status${problemNumber}`).className = "status success";
            } else {
                // Movimiento de las negras - CORREGIDO
                setTimeout(() => makeBlackMove(problemNumber), 500);
            }
        } else {
            document.getElementById(`status${problemNumber}`).textContent = "Movimiento incorrecto. Intenta de nuevo.";
            document.getElementById(`status${problemNumber}`).className = "status error";
            // Revertir movimiento
            state.currentPosition[fromRow][fromCol] = piece;
            state.currentPosition[toRow][toCol] = '';
            state.playerMoves.pop();
        }
    }
    
    clearSelection(problemNumber);
    createBoard(problemNumber);
}
