<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo de Cifrado - Acceso Root</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #050505;
            --bg-panel: #0a0a0a;
            --primary: #00ff41; /* Verde Matrix */
            --primary-dim: rgba(0, 255, 65, 0.1);
            --danger: #ff003c;
            --text-main: #e0e0e0;
            --border: #333;
            /* Nuevo color para indicador de movimiento */
            --valid-indicator: rgba(0, 255, 65, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* EFECTO CRT */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
            position: relative;
            z-index: 3;
        }

        h1 { color: var(--primary); text-shadow: 0 0 10px var(--primary); letter-spacing: 2px; }

        /* PANTALLAS (Vistas) */
        .screen {
            display: none;
            flex-grow: 1;
            position: relative;
            z-index: 3;
            padding: 2rem;
            animation: fadeIn 0.5s;
        }
        .screen.active { display: flex; }

        /* VISTA 1: SELECCI√ìN DE MISIONES (GRID) */
        #mission-select-screen {
            flex-direction: column;
            align-items: center;
        }

        .mission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            width: 100%;
            max-width: 1400px;
            margin-top: 2rem;
        }

        /* TARJETAS DE MISIONES */
        .mission-card {
            background: #000;
            border: 1px solid var(--border);
            padding: 2rem;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .mission-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px var(--primary-dim);
            transform: translateY(-5px);
        }

        .mission-card::before {
            content: "LOCKED";
            position: absolute;
            top: 20px; right: -30px;
            background: var(--danger);
            color: black;
            font-size: 0.7rem;
            padding: 5px 30px;
            transform: rotate(45deg);
            font-weight: bold;
        }

        .mission-icon { font-size: 2rem; margin-bottom: 1rem; color: var(--primary); }
        .mission-title { font-size: 1.5rem; margin-bottom: 0.5rem; color: white; font-weight: bold; }
        .mission-desc { 
            color: #888; font-size: 0.9rem; line-height: 1.4; font-family: 'Courier New', monospace; flex-grow: 1;
        }
        .mission-desc::before { content: "> "; color: var(--primary); }
        
        .mission-footer {
            margin-top: 15px;
            border-top: 1px dashed #333;
            padding-top: 10px;
            font-size: 0.8rem;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
        }

        /* VISTA 2: INTERFAZ DE JUEGO */
        #game-interface {
            display: none;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: 100%;
            padding: 0;
        }
        #game-interface.active { display: grid; }

        /* TABLERO */
        .board-area {
            display: flex;
            justify-content: center;
            align-items: center;
            background: #080808;
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 70px);
            grid-template-rows: repeat(8, 70px);
            border: 2px solid var(--primary);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.1);
        }

        .square {
            display: flex; align-items: center; justify-content: center;
            font-size: 45px; cursor: pointer; position: relative;
        }

        .light { background-color: #0f2615; color: var(--primary); }
        .dark { background-color: #030f06; color: var(--primary); }
        
        /* Highlight Selecci√≥n */
        .square.selected { background-color: rgba(0, 255, 65, 0.2) !important; box-shadow: inset 0 0 15px var(--primary); }
        
        /* --- INDICADORES DE MOVIMIENTO (NUEVO) --- */
        
        /* 1. Punto Verde (Movimiento v√°lido a casilla vac√≠a) */
        .valid-move::after {
            content: ''; position: absolute;
            width: 18px; height: 18px;
            background-color: var(--valid-indicator);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--primary);
            pointer-events: none;
        }
        
        /* 2. Mira de Captura (Comer pieza enemiga) */
        .capture-move {
            box-shadow: inset 0 0 15px var(--danger);
        }
        .capture-move::after {
            content: ''; position: absolute;
            width: 70%; height: 70%;
            border: 2px dashed var(--danger);
            box-sizing: border-box;
            border-radius: 50%;
            animation: spin 4s linear infinite;
            pointer-events: none;
        }

        /* PANEL LATERAL */
        .side-panel {
            background: #0a0a0a;
            border-left: 1px solid var(--border);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .back-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            margin-bottom: 1rem;
            align-self: flex-start;
        }
        .back-btn:hover { border-color: var(--primary); color: var(--primary); }

        .terminal-log {
            background: #000;
            border: 1px solid #333;
            flex-grow: 1;
            max-height: 300px;
            padding: 10px;
            font-size: 0.8rem;
            color: #aaa;
            overflow-y: auto;
            margin-bottom: 2rem;
        }
        .log-entry { margin-bottom: 5px; }
        .log-entry::before { content: "> "; color: var(--primary); }
        .log-entry.err { color: var(--danger); }
        .log-entry.sys { color: var(--primary); }

        /* INPUT SEGURO */
        .cipher-box {
            border: 2px dashed #444;
            padding: 1.5rem;
            position: relative;
            transition: all 0.5s;
        }
        .cipher-box.unlocked {
            border-color: var(--primary);
            border-style: solid;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .cipher-input {
            width: 100%;
            background: #111;
            border: 1px solid #333;
            color: white;
            padding: 1rem;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 10px;
        }
        .cipher-input:disabled { background: #080808; color: #444; cursor: not-allowed; }

        .btn-submit {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: black;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }
        .btn-submit:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* OVERLAYS */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center; z-index: 10;
            backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }

        .data-packet {
            border: 2px solid var(--primary);
            padding: 2rem;
            background: #000;
            text-align: center;
            max-width: 500px;
            animation: glitch 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 900px) {
            #game-interface { grid-template-columns: 1fr; grid-template-rows: auto auto; overflow-y: auto; }
            .board { grid-template-columns: repeat(8, 45px); grid-template-rows: repeat(8, 45px); }
            .square { font-size: 30px; }
            .side-panel { padding: 1rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1><span style="color:white">CYBER</span>_CHESS_PROTOCOL</h1>
        <div style="font-size: 0.8rem; color: #666;">SYS_ADMIN_ACCESS: <span style="color:var(--danger)">RESTRICTED</span></div>
    </header>

    <div id="mission-select-screen" class="screen active">
        <h2 style="margin-top: 1rem; border-bottom: 1px solid #333; padding-bottom: 10px; width: 100%; max-width: 1400px; color: var(--text-main);">
            // SELECCIONAR_VULNERABILIDAD
        </h2>
        
        <div class="mission-grid">
            <div class="mission-card" onclick="loadMission(1)">
                <div class="mission-icon">üîí</div>
                <div class="mission-title">NODE_01</div>
                <div class="mission-desc">ERROR 503: Servicio de autenticaci√≥n no responde. Gateway inaccesible.</div>
                <div class="mission-footer"><span>PORT: 8080</span><span>STATUS: ACTIVE</span></div>
            </div>

            <div class="mission-card" onclick="loadMission(2)">
                <div class="mission-icon">üì°</div>
                <div class="mission-title">NODE_02</div>
                <div class="mission-desc">Tr√°fico interceptado. Checksum incorrecto en el stream de datos.</div>
                <div class="mission-footer"><span>TYPE: STREAM</span><span>ENC: UNKNOWN</span></div>
            </div>

            <div class="mission-card" onclick="loadMission(3)">
                <div class="mission-icon">üíæ</div>
                <div class="mission-title">NODE_03</div>
                <div class="mission-desc">Violaci√≥n de segmento. Volcado de memoria incompleto.</div>
                <div class="mission-footer"><span>ADDR: 0x0F4A</span><span>MEM: CORRUPT</span></div>
            </div>

            <div class="mission-card" onclick="loadMission(4)">
                <div class="mission-icon">‚ö†Ô∏è</div>
                <div class="mission-title">NODE_04</div>
                <div class="mission-desc">Alerta de seguridad: Protocolo interrumpido. Exceso de peticiones.</div>
                <div class="mission-footer"><span>PID: 4421</span><span>QUEUE: FULL</span></div>
            </div>

            <div class="mission-card" onclick="loadMission(5)">
                <div class="mission-icon">üåê</div>
                <div class="mission-title">NODE_05</div>
                <div class="mission-desc">Anomal√≠a en capa de transporte. Latencia inusual detectada.</div>
                <div class="mission-footer"><span>NET: TCP/IP</span><span>FLAG: SYN_ACK</span></div>
            </div>

            <div class="mission-card" onclick="loadMission(6)">
                <div class="mission-icon">‚ò¢Ô∏è</div>
                <div class="mission-title">NODE_06</div>
                <div class="mission-desc">¬°CR√çTICO! Archivo de sistema bloqueado. Firma digital no reconocida.</div>
                <div class="mission-footer"><span>LEVEL: KERNEL</span><span>PERM: DENIED</span></div>
            </div>
        </div>
    </div>

    <div id="game-interface" class="screen">
        <div class="board-area">
            <div id="board" class="board"></div>

            <div id="victory-overlay" class="overlay">
                <div class="data-packet">
                    <h2 style="color: white; margin-bottom: 15px;">ACCESO AL N√öCLEO CONCEDIDO</h2>
                    <p style="color: #888; margin-bottom: 10px;">Hash desencriptado:</p>
                    <div id="hash-display" style="font-size: 2rem; color: var(--primary); border: 1px dashed var(--primary); padding: 10px; margin-bottom: 20px;">---</div>
                    <p style="font-size: 0.8rem; color: var(--danger); margin-bottom: 20px;">[ ! ] COPIA EL HASH Y √öSALO EN EL PANEL LATERAL.</p>
                    <button onclick="closeOverlay()" style="background: transparent; border: 1px solid white; color: white; padding: 10px 20px; cursor: pointer; font-family:inherit;">CERRAR Y DESCIFRAR</button>
                </div>
            </div>
        </div>

        <div class="side-panel">
            <button class="back-btn" onclick="returnToMenu()">‚Üê DESCONECTAR</button>
            
            <div style="margin-bottom: 5px; color: #666;">// TERMINAL_OUTPUT</div>
            <div id="terminal" class="terminal-log">
                <div class="log-entry">Esperando conexi√≥n...</div>
            </div>

            <div style="flex-grow: 1;"></div>
            <div id="cipher-box" class="cipher-box">
                <span id="cipher-status" style="position: absolute; top: -10px; left: 20px; background: #0a0a0a; padding: 0 10px; color: #666; font-size: 0.8rem;">üîí INPUT BLOQUEADO</span>
                
                <p style="font-size: 0.8rem; color: #555; margin-bottom: 15px;">
                    Jaque Mate requerido para desbloquear la entrada de datos.
                </p>
                
                <input type="text" id="solution-input" class="cipher-input" placeholder="ACCESO DENEGADO" disabled autocomplete="off">
                <button id="submit-btn" class="btn-submit" onclick="verifySolution()" disabled>VALIDAR PAYLOAD</button>
                <div id="feedback-msg" style="text-align: center; margin-top: 10px; height: 20px; font-weight: bold;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE NIVELES (MISMOS 3 NIVELES REPLICADOS PARA 6 NODOS) ---
        const levels = {
            1: {
                initial: [
                    ['', '', '', '', 'b', '', '', ''],
                    ['', '', 'p', '', 'B', '', 'p', ''],
                    ['', '', '', '', '', '', '', ''],
                    ['', '', 'P', '', '', 'p', 'P', ''],
                    ['', 'P', '', 'P', '', 'P', '', 'P'],
                    ['', '', 'p', '', 'K', '', 'p', ''],
                    ['', '', 'P', '', 'B', '', 'P', ''],
                    ['', '', '', '', 'k', '', '', '']
                ],
                moves: [
                    { w: {f:{r:3,c:6}, t:{r:2,c:6}}, b: {f:{r:1,c:2}, t:{r:2,c:2}} },
                    { w: {f:{r:4,c:7}, t:{r:3,c:7}}, b: {f:{r:0,c:4}, t:{r:1,c:3}} },
                    { w: {f:{r:1,c:4}, t:{r:4,c:7}}, b: {f:{r:1,c:3}, t:{r:0,c:2}} },
                    { w: {f:{r:4,c:7}, t:{r:5,c:6}}, b: null }
                ],
                fakeHash: "SQL-INJECT-01", answer: "ADMIN"
            },
            2: {
                initial: [
                    ['', '', 'k', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', ''],
                    ['', '', '', '', 'K', '', '', ''],
                    ['', '', '', 'N', 'B', '', '', ''],
                    ['', '', '', '', 'N', '', '', ''],
                    ['', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '']
                ],
                moves: [
                    { w: {f:{r:4,c:4}, t:{r:3,c:2}}, b: {f:{r:0,c:2}, t:{r:0,c:3}} },
                    { w: {f:{r:2,c:4}, t:{r:1,c:5}}, b: {f:{r:0,c:3}, t:{r:0,c:2}} },
                    { w: {f:{r:3,c:3}, t:{r:2,c:1}}, b: {f:{r:0,c:2}, t:{r:0,c:3}} },
                    { w: {f:{r:3,c:2}, t:{r:2,c:4}}, b: null }
                ],
                fakeHash: "CESAR-ROT13", answer: "SECRET"
            },
            3: {
                initial: [
                    ['', 'n', '', 'b', '', 'r', 'k', ''],
                    ['', '', 'p', 'p', '', '', '', 'p'],
                    ['', '', '', 'p', '', '', 'p', 'Q'],
                    ['', '', '', 'R', '', 'p', '', ''],
                    ['', '', '', '', 'B', 'B', 'P', ''],
                    ['', '', '', 'P', 'R', '', 'P', ''],
                    ['', '', '', '', '', '', 'P', 'K'],
                    ['', '', '', '', '', '', '', '']
                ],
                moves: [
                    { w: {f:{r:3,c:3}, t:{r:3,c:5}}, b: {f:{r:0,c:5}, t:{r:3,c:5}} },
                    { w: {f:{r:4,c:4}, t:{r:3,c:3}}, b: {f:{r:3,c:5}, t:{r:3,c:3}} },
                    { w: {f:{r:5,c:4}, t:{r:0,c:4}}, b: {f:{r:0,c:6}, t:{r:1,c:5}} },
                    { w: {f:{r:2,c:7}, t:{r:0,c:5}}, b: null }
                ],
                fakeHash: "STACK-OVERFLOW", answer: "ROOT"
            }
        };

        // Copiamos niveles para tener 6 funcionales
        levels[4] = levels[1];
        levels[5] = levels[2];
        levels[6] = levels[3];

        const pieces = { 'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô', 'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü' };
        
        // ESTADO GLOBAL
        let currentMissionId = 1;
        let gameState = {
            position: [],
            moveIdx: 0,
            selection: null,
            locked: false,
            validMoves: []
        };

        // --- NAVEGACI√ìN ---
        function loadMission(id) {
            currentMissionId = id;
            document.getElementById('mission-select-screen').classList.remove('active');
            document.getElementById('game-interface').classList.add('active');
            
            // Reiniciar juego
            gameState.position = JSON.parse(JSON.stringify(levels[id].initial));
            gameState.moveIdx = 0;
            gameState.selection = null;
            gameState.locked = false;
            gameState.validMoves = [];
            
            // Bloquear input
            lockInput();
            document.getElementById('terminal').innerHTML = '';
            log(`Conectando a NODE_0${id}... Iniciando protocolo.`, false, true);
            document.getElementById('victory-overlay').classList.remove('active');
            
            drawBoard();
        }

        function returnToMenu() {
            document.getElementById('game-interface').classList.remove('active');
            document.getElementById('mission-select-screen').classList.add('active');
        }

        // --- RENDERIZADO DEL TABLERO ---
        function drawBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for(let r=0; r<8; r++) {
                for(let c=0; c<8; c++) {
                    const sq = document.createElement('div');
                    sq.className = `square ${(r+c)%2===0 ? 'light' : 'dark'}`;
                    
                    const p = gameState.position[r][c];
                    if(p) {
                        sq.innerText = pieces[p];
                        // Piezas blancas brillan, negras son oscuras
                        sq.style.color = (p === p.toUpperCase()) ? 'var(--primary)' : '#1a4d2e';
                        sq.style.textShadow = (p === p.toUpperCase()) ? '0 0 5px var(--primary)' : 'none';
                    }
                    
                    sq.onclick = () => handleSquare(r, c);
                    
                    if(gameState.selection && gameState.selection.r === r && gameState.selection.c === c) {
                        sq.classList.add('selected');
                    }
                    
                    // MOSTRAR INDICADORES VISUALES
                    const moveType = getMoveType(r, c);
                    if(moveType === 'move') sq.classList.add('valid-move');
                    if(moveType === 'capture') sq.classList.add('capture-move');

                    board.appendChild(sq);
                }
            }
        }

        function getMoveType(r, c) {
            const move = gameState.validMoves.find(m => m.r === r && m.c === c);
            return move ? move.type : null;
        }

        // --- MOTOR DE AJEDREZ (C√°lculo de movimientos posibles) ---
        function calculatePossibleMoves(r, c, piece) {
            let moves = [];
            const type = piece.toUpperCase();
            const isWhite = piece === piece.toUpperCase();
            
            const add = (tr, tc) => {
                if(tr<0||tr>7||tc<0||tc>7) return false;
                const target = gameState.position[tr][tc];
                if(!target) {
                    moves.push({r:tr, c:tc, type:'move'});
                    return true; // Sigue buscando en esta direcci√≥n
                } else if((isWhite && target===target.toLowerCase()) || (!isWhite && target===target.toUpperCase())) {
                    moves.push({r:tr, c:tc, type:'capture'});
                    return false; // Bloqueado por captura
                }
                return false; // Bloqueado por pieza propia
            };

            if(type === 'P') { // Pe√≥n (Blancas suben, index--)
                const dir = -1; 
                if(r+dir >= 0 && !gameState.position[r+dir][c]) {
                    moves.push({r:r+dir, c:c, type:'move'});
                    if(r===6 && !gameState.position[r+(dir*2)][c]) moves.push({r:r+(dir*2), c:c, type:'move'});
                }
                if(r+dir >= 0 && c>0 && gameState.position[r+dir][c-1] && gameState.position[r+dir][c-1]===gameState.position[r+dir][c-1].toLowerCase()) 
                    moves.push({r:r+dir, c:c-1, type:'capture'});
                if(r+dir >= 0 && c<7 && gameState.position[r+dir][c+1] && gameState.position[r+dir][c+1]===gameState.position[r+dir][c+1].toLowerCase()) 
                    moves.push({r:r+dir, c:c+1, type:'capture'});
            }
            if(type === 'R' || type === 'Q') { // Torre/Reina
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                    for(let i=1; i<8; i++) if(!add(r+dr*i, c+dc*i)) break;
                });
            }
            if(type === 'B' || type === 'Q') { // Alfil/Reina
                [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
                    for(let i=1; i<8; i++) if(!add(r+dr*i, c+dc*i)) break;
                });
            }
            if(type === 'N') { // Caballo
                [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc]) => add(r+dr, c+dc));
            }
            if(type === 'K') { // Rey
                [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => add(r+dr, c+dc));
            }
            return moves;
        }

        // --- INTERACCI√ìN ---
        function handleSquare(r, c) {
            if(gameState.locked) return;
            
            const p = gameState.position[r][c];
            // 1. Selecci√≥n de pieza blanca
            if(p && p === p.toUpperCase()) {
                gameState.selection = {r, c};
                gameState.validMoves = calculatePossibleMoves(r, c, p);
                drawBoard();
                return;
            }
            
            // 2. Intentar mover
            if(gameState.selection) {
                // Verificar si el clic es un movimiento posible calculado
                const validMove = gameState.validMoves.find(m => m.r === r && m.c === c);
                
                if(validMove) {
                    const puzzleMove = levels[currentMissionId].moves[gameState.moveIdx].w;
                    
                    // Verificar si es el movimiento CORRECTO del puzzle
                    if(puzzleMove.f.r === gameState.selection.r && puzzleMove.f.c === gameState.selection.c &&
                       puzzleMove.t.r === r && puzzleMove.t.c === c) {
                        
                        executeMove(gameState.selection, {r, c}, true);
                        
                    } else {
                        log("Error: Movimiento ineficaz. Protocolo fallido.", true);
                        gameState.selection = null;
                        gameState.validMoves = [];
                        drawBoard();
                    }
                } else {
                    // Clic en casilla no v√°lida -> Deseleccionar
                    gameState.selection = null;
                    gameState.validMoves = [];
                    drawBoard();
                }
            }
        }

        function executeMove(from, to, isPlayer) {
            const p = gameState.position[from.r][from.c];
            gameState.position[to.r][to.c] = p;
            gameState.position[from.r][from.c] = '';
            
            log(`${isPlayer ? 'USR' : 'SYS'} ejecuta: ${coords(from)} -> ${coords(to)}`, false, isPlayer);
            
            gameState.selection = null;
            gameState.validMoves = [];
            drawBoard();
            
            if(isPlayer) {
                const step = levels[currentMissionId].moves[gameState.moveIdx];
                if(!step.b) {
                    setTimeout(missionComplete, 500);
                } else {
                    gameState.locked = true;
                    setTimeout(() => {
                        executeMove(step.b.f, step.b.t, false);
                        gameState.moveIdx++;
                        gameState.locked = false;
                    }, 800);
                }
            }
        }

        function missionComplete() {
            log("AMENAZA NEUTRALIZADA. OBTENIENDO HASH...", false, true);
            const mission = levels[currentMissionId];
            
            document.getElementById('hash-display').innerText = mission.fakeHash;
            document.getElementById('victory-overlay').classList.add('active');
            
            unlockInput();
        }

        function closeOverlay() {
            document.getElementById('victory-overlay').classList.remove('active');
        }

        // --- SISTEMA DE INPUT ---
        function lockInput() {
            const box = document.getElementById('cipher-box');
            const inp = document.getElementById('solution-input');
            const btn = document.getElementById('submit-btn');
            const status = document.getElementById('cipher-status');
            
            box.classList.remove('unlocked');
            inp.disabled = true;
            inp.value = '';
            inp.placeholder = "ACCESO DENEGADO";
            btn.disabled = true;
            status.innerText = "üîí INPUT BLOQUEADO";
            status.style.color = "#666";
            document.getElementById('feedback-msg').innerText = '';
        }

        function unlockInput() {
            const box = document.getElementById('cipher-box');
            const inp = document.getElementById('solution-input');
            const btn = document.getElementById('submit-btn');
            const status = document.getElementById('cipher-status');
            
            box.classList.add('unlocked');
            inp.disabled = false;
            inp.placeholder = "INTRODUZCA HASH";
            inp.focus();
            btn.disabled = false;
            status.innerText = "üîì PUERTO ABIERTO";
            status.style.color = "var(--primary)";
        }

        function verifySolution() {
            const val = document.getElementById('solution-input').value.toUpperCase().replace(/-/g, '').trim();
            const correct = levels[currentMissionId].answer;
            const feedback = document.getElementById('feedback-msg');
            
            if(val === correct) {
                feedback.innerText = "ACCESO CONCEDIDO.";
                feedback.style.color = "var(--primary)";
                log("Credencial verificada. Archivo guardado.", false, true);
                setTimeout(() => {
                    alert("¬°Misi√≥n Cumplida! Volviendo al men√∫.");
                    returnToMenu();
                }, 1000);
            } else {
                feedback.innerText = "ERROR DE CREDENCIAL";
                feedback.style.color = "var(--danger)";
                log("Intento de inyecci√≥n fallido.", true);
            }
        }

        // --- UTILS ---
        function log(msg, err=false, success=false) {
            const t = document.getElementById('terminal');
            const d = document.createElement('div');
            d.className = 'log-entry';
            if(err) d.classList.add('err');
            if(success) d.classList.add('sys');
            d.innerText = msg;
            t.appendChild(d);
            t.scrollTop = t.scrollHeight;
        }

        function coords(o) { return `${String.fromCharCode(97+o.c)}${8-o.r}`; }

    </script>
</body>
</html>
